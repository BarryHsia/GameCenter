# GameCenter 现代化重构方案

## 1. 当前技术栈评估

| 类别 | 当前版本 | 评估 |
|------|---------|------|
| Kotlin | 2.2.0 | ✅ 最新 |
| AGP | 8.10.1 | ✅ 最新 |
| Compose | 1.8.3 (UI Tooling) | ⚠️ 可升级 |
| Navigation | 2.9.3 | ✅ 最新，已用 Type-Safe Routes |
| Room | 2.7.2 | ✅ 最新 |
| Hilt | 2.57.2 | ✅ 最新 |
| Retrofit | 3.0.0 | ✅ 最新 |
| OkHttp | 5.1.0 | ✅ 最新 |
| Coil | 3.3.0 | ✅ 最新 |
| DataStore | 1.2.0-alpha02 | ⚠️ 可升级到稳定版 |
| TV Material | 1.0.1 | ✅ 最新 |
| KSP | 2.2.0-2.0.2 | ✅ 最新 |
| Kotlinx Serialization | 1.9.0 | ✅ 最新 |
| Arrow Core | 2.1.2 | ✅ 最新 |

**结论**：依赖版本整体已经很新，重构重点应放在架构模式和代码质量上。

---

## 2. 核心问题分析

### 2.1 架构层面
1. **缺少 Domain Layer**：ViewModel 直接调用 AppApi，没有 UseCase 抽象
2. **GcAppState 过度膨胀**：承载了所有依赖（AppApi、DownloadManager、InstallManager 等），作为"上帝对象"传递给所有 Screen
3. **ViewModel 手动创建**：使用 `viewModel { }` 手动构造，未利用 Hilt ViewModel 注入
4. **ViewModel 职责过重**：GameDetailsViewModel 同时处理下载、安装、播放记录、Google Play 检测等

### 2.2 数据层面
1. **Gson + Kotlinx Serialization 混用**：API 用 Gson，导航用 Kotlinx Serialization
2. **AppApiImpl 手动创建 Retrofit**：未通过 Hilt 注入 OkHttpClient/Retrofit
3. **HTTP 明文传输**：`usesCleartextTraffic=true`，BASE_URL 使用 http

### 2.3 UI 层面
1. **Screen 函数参数过多**：DownloaderScreen 接收 4 个依赖参数
2. **CompositionLocal 滥用**：LocalNavController、LocalGcAppState
3. **缺少 UiState 封装**：多个独立 StateFlow 而非统一的 UiState sealed class

### 2.4 其他
1. **硬编码依赖**：EventReportSdk AAR、RxJava2/3 混用（仅为 SDK 依赖）
2. **AndroidAutoSize 库**：可用 Compose 原生适配替代
3. **缺少错误处理统一层**：各处 catch 分散处理

---

## 3. 重构方案

### 3.1 引入 Domain Layer（UseCase 模式）

```
data/                          → 数据层（不变）
domain/                        → 新增领域层
  ├── model/                   → 领域模型
  ├── repository/              → Repository 接口
  └── usecase/                 → UseCase
      ├── GetContentConfigsUseCase.kt
      ├── GetGameInfoUseCase.kt
      ├── SearchGamesUseCase.kt
      ├── DownloadGameUseCase.kt
      ├── InstallGameUseCase.kt
      └── GetDownloadUrlUseCase.kt
ui/                            → UI 层
  └── *ViewModel.kt            → 只依赖 UseCase
```

### 3.2 消除 GcAppState 上帝对象

**Before**：
```kotlin
class GcAppState(
    val appApi: AppApi,
    val downloadManager: DownloadManager,
    val installManager: InstallManager,
    val settingsManager: SettingsManager,
    // ... 更多依赖
)
```

**After**：
```kotlin
// GcAppState 只保留导航和全局 UI 状态
@Stable
class GcAppState(
    val navController: NavHostController,
    val snackbarHostState: SnackbarHostState,
    val isOffline: StateFlow<Boolean>,
)

// 各 ViewModel 通过 Hilt 注入自己的依赖
@HiltViewModel
class GameDetailsViewModel @Inject constructor(
    private val getGameInfoUseCase: GetGameInfoUseCase,
    private val downloadGameUseCase: DownloadGameUseCase,
    private val installGameUseCase: InstallGameUseCase,
    savedStateHandle: SavedStateHandle,
) : ViewModel()
```

### 3.3 Hilt ViewModel 注入

**Before**：
```kotlin
val viewModel = viewModel {
    GameDetailsViewModel(
        appApi = appState.appApi,
        param = route,
        downloadManager = appState.downloadManager,
        // ... 手动传递 8+ 个参数
    )
}
```

**After**：
```kotlin
@HiltViewModel
class GameDetailsViewModel @Inject constructor(
    private val getGameInfoUseCase: GetGameInfoUseCase,
    private val downloadGameUseCase: DownloadGameUseCase,
    savedStateHandle: SavedStateHandle,
) : ViewModel() {
    private val route = savedStateHandle.toRoute<GameDetailsRoute>()
}

// Screen 中
val viewModel: GameDetailsViewModel = hiltViewModel()
```

### 3.4 统一 UiState 模式

**Before**：
```kotlin
val loading: StateFlow<Boolean>
val label: StateFlow<String>
val desc: StateFlow<String>
val tags: StateFlow<List<String>>
val isDownloading: StateFlow<Boolean>
// ... 20+ 个独立 StateFlow
```

**After**：
```kotlin
sealed interface GameDetailsUiState {
    data object Loading : GameDetailsUiState
    data object Error : GameDetailsUiState
    data class Success(
        val info: GameInfo,
        val downloadState: DownloadState,
        val installState: InstallState,
    ) : GameDetailsUiState
}

val uiState: StateFlow<GameDetailsUiState>
```

### 3.5 统一序列化为 Kotlinx Serialization

移除 Gson，Retrofit 使用 kotlinx-serialization-converter：

```kotlin
// 数据模型
@Serializable
data class ContentConfig(...)

// Retrofit
Retrofit.Builder()
    .addConverterFactory(Json.asConverterFactory("application/json".toMediaType()))
    .build()
```

### 3.6 网络层重构

```kotlin
// 通过 Hilt 注入
@Module
@InstallIn(SingletonComponent::class)
object NetworkModule {
    @Provides @Singleton
    fun provideOkHttpClient(): OkHttpClient { ... }

    @Provides @Singleton
    fun provideRetrofit(client: OkHttpClient): Retrofit { ... }

    @Provides @Singleton
    fun provideApiService(retrofit: Retrofit): ApiService { ... }
}

// Repository 模式
class GameRepository @Inject constructor(
    private val apiService: ApiService,
) {
    fun getContentConfigs(): Flow<List<ContentConfig>> = flow { ... }
}
```

### 3.7 Navigation 简化

Screen 函数不再接收依赖参数，只接收导航回调：

```kotlin
fun NavGraphBuilder.gameDetailsScreen(
    onNavigateBack: () -> Unit,
    onNavigateToWeb: (String) -> Unit,
) {
    composable<GameDetailsRoute> {
        val viewModel: GameDetailsViewModel = hiltViewModel()
        val uiState by viewModel.uiState.collectAsStateWithLifecycle()
        GameDetailsScreen(
            uiState = uiState,
            onAction = viewModel::onAction,
            onNavigateBack = onNavigateBack,
        )
    }
}
```

---

## 4. 重构后项目结构

```
com.kgzn.gamecenter/
├── GameCenterApplication.kt
├── MainActivity.kt
├── data/
│   ├── model/                    → API 响应模型（@Serializable）
│   │   ├── ContentConfig.kt
│   │   ├── Component.kt
│   │   ├── Resource.kt
│   │   ├── Info.kt
│   │   ├── Search2.kt
│   │   └── ApiResponse.kt
│   ├── remote/
│   │   ├── ApiService.kt         → Retrofit 接口
│   │   └── interceptor/
│   ├── local/
│   │   └── LocalDataProvider.kt
│   ├── repository/               → Repository 实现
│   │   ├── GameRepository.kt
│   │   ├── DownloadRepository.kt
│   │   └── SettingsRepository.kt
│   └── di/
│       ├── NetworkModule.kt      → OkHttp + Retrofit + ApiService
│       ├── DatabaseModule.kt     → Room
│       └── RepositoryModule.kt   → Repository 绑定
├── domain/
│   ├── model/                    → 领域模型
│   │   ├── Game.kt
│   │   ├── GameDetail.kt
│   │   ├── DownloadState.kt
│   │   └── InstallState.kt
│   └── usecase/
│       ├── GetContentConfigsUseCase.kt
│       ├── GetGameInfoUseCase.kt
│       ├── SearchGamesUseCase.kt
│       ├── DownloadGameUseCase.kt
│       └── InstallGameUseCase.kt
├── feature/
│   ├── downloader/               → 下载引擎（保持不变，已足够成熟）
│   ├── installer/                → 安装管理
│   ├── network/                  → 网络监控
│   └── settings/                 → 设置管理
├── ui/
│   ├── GcApp.kt                  → 简化，只管导航和全局 UI
│   ├── GcAppState.kt             → 精简，只保留导航状态
│   ├── home/
│   │   ├── HomeScreen.kt
│   │   ├── HomeViewModel.kt      → @HiltViewModel
│   │   └── HomeUiState.kt
│   ├── gamedetails/
│   │   ├── GameDetailsScreen.kt
│   │   ├── GameDetailsViewModel.kt → @HiltViewModel
│   │   └── GameDetailsUiState.kt
│   ├── search/
│   ├── downloader/
│   ├── settings/
│   └── ...
└── designsystem/                 → 设计系统（保持不变）
```

---

## 5. 重构优先级与执行计划

### Phase 1：基础架构（高优先级）✅ 已完成
1. ✅ 引入 Hilt ViewModel 注入（`hilt-navigation-compose`）— 所有 ViewModel 已迁移
2. ✅ 精简 GcAppState，移除业务依赖 — 仅保留 navController/snackbar/network/playRecords
3. ✅ 创建 GameRepository 包装 AppApi
4. ✅ 创建 SettingsViewModel、UninstallerViewModel
5. ✅ GameDetailsViewModel 迁移到 @HiltViewModel + SavedStateHandle
6. ⬜ 重构网络层，Retrofit/OkHttp 通过 Hilt 注入（AppApiImpl 仍手动创建）
7. ⬜ 统一序列化为 Kotlinx Serialization（仍使用 Gson）

### Phase 2：领域层（中优先级）
5. ⬜ 引入 Repository 接口 + 实现分离
6. ⬜ 引入 UseCase 模式
7. ⬜ 统一 UiState sealed class

### Phase 3：代码质量（低优先级）
8. ⬜ 移除 AndroidAutoSize，使用 Compose 原生适配
9. ⬜ 移除 Gson 依赖
10. ⬜ 统一错误处理
11. ⬜ 添加单元测试

---

## 6. 依赖变更

### 新增
```toml
[libraries]
# Hilt Navigation Compose
hilt-navigation-compose = { module = "androidx.hilt:hilt-navigation-compose", version = "1.2.0" }
# Kotlinx Serialization Retrofit Converter
retrofit-kotlinx-serialization = { module = "com.squareup.retrofit2:converter-kotlinx-serialization", version = "3.0.0" }
# OkHttp Logging (调试用)
okhttp-logging = { module = "com.squareup.okhttp3:logging-interceptor", version = "5.1.0" }
```

### 移除
```toml
# 移除 Gson（用 Kotlinx Serialization 替代）
converter-gson
gson
# 移除 AndroidAutoSize（用 Compose 原生替代）
# me.jessyan:autosize:1.2.1
```

---

## 7. 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 下载引擎重构 | 高 | 保持不变，仅调整 DI 接入方式 |
| EventReportSdk 兼容性 | 中 | 保持 AAR 和 RxJava 依赖不变 |
| 系统签名权限 | 低 | 不涉及 Manifest 变更 |
| TV 焦点导航 | 中 | UI 重构时保持焦点管理逻辑 |
