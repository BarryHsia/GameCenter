# GameCenter 项目分析文档

## 1. 项目概述

GameCenter（游戏中心）是一款运行在 Android TV 上的游戏商城应用，由 `com.kgzn.gamecenter` 开发。用户可以通过遥控器或手柄浏览、搜索、下载、安装和游玩游戏，同时支持 APK 原生游戏和 H5 网页游戏两种类型。

- 包名：`com.kgzn.gamecenter`
- 最低 SDK：29 (Android 10)
- 目标 SDK：36
- 设计分辨率：960×540dp（横屏）
- 使用系统签名（`android.uid.system`），拥有系统级权限（静默安装/卸载）

---

## 2. 功能模块

### 2.1 首页（Home）
- 顶部侧边栏展示分类标签页（从服务端动态获取 `ContentConfig`），支持 VerticalPager 切换
- 第一个页面为「我的」页面，包含：
  - 最近游玩记录（最多保留 10 条）
  - 快捷入口：手柄管理、下载管理、卸载管理、设置、关于
- 其余页面为内容分类页，展示 Banner 和游戏列表（由 `Component` + `Resource` 组成）

### 2.2 游戏详情（GameDetails）
- 展示游戏信息：标题、描述、标签、控制方式（手柄/遥控器）、背景图、相关推荐
- 根据游戏类型（`packetType`）区分行为：
  - APK 游戏：下载 → 安装 → 打开，支持暂停/继续/取消下载，检测版本更新
  - H5 游戏：直接通过内置 WebView 打开
- 支持 Google Play 依赖检测，若游戏需要 Google Play 但未安装则弹窗引导
- 支持 Deep Link 跳转：`gamecenter://details?configId=&dataId=&contentType=&dataType=`
- 游玩时记录到 PlayRecord 并上报事件（EventReportSdk）

### 2.3 搜索（Search）
- 关键词搜索游戏，带防抖延迟
- 调用 `/appapi/search2` 接口，展示搜索结果列表
- 点击结果跳转到游戏详情页

### 2.4 下载管理（Downloader）
- 展示所有下载任务列表，按添加时间倒序排列
- 支持操作：暂停、继续、删除、安装已完成的游戏
- 下载状态：Added → Downloading → Completed / Paused / Error
- 最多同时 5 个下载任务，超出自动暂停最早的任务
- 下载完成后可自动安装（可在设置中开关）
- 安装完成后可自动清除安装包（可在设置中开关）

### 2.5 安装与卸载
- 使用 `PackageInstaller` API 进行静默安装（系统签名权限）
- 安装/卸载状态通过 `InstallEvents` 事件流通知全局
- 卸载管理页面列出已安装的游戏，支持批量卸载

### 2.6 手柄管理（Input）
- 游戏手柄连接引导（USB / 蓝牙）
- 已连接设备管理，支持断开连接
- 需要蓝牙相关权限（`BLUETOOTH`, `BLUETOOTH_CONNECT`, `BLUETOOTH_PRIVILEGED`）

### 2.7 设置（Settings）
- 下载完成后自动安装（默认开启）
- 安装完成后清除安装包（默认开启）
- 使用 DataStore Preferences 持久化

### 2.8 WebView
- 内置浏览器，用于打开 H5 游戏或外部链接
- 支持通过 Intent 拦截 http/https 链接

### 2.9 国际化
- 支持 21 种语言/地区，包括：中文简体、中文繁体、英语、日语、韩语、阿拉伯语、德语、西班牙语、法语、印尼语、意大利语、希伯来语、荷兰语、波兰语、葡萄牙语、俄语、泰语、乌克兰语、乌兹别克语、越南语、波斯语

---

## 3. 技术架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────┐
│                   UI Layer                       │
│  Jetpack Compose + TV Material + Navigation      │
│  (HomeScreen, GameDetails, Search, Downloader…)  │
├─────────────────────────────────────────────────┤
│               ViewModel Layer                    │
│  HomeViewModel, GameDetailsViewModel,            │
│  SearchViewModel, DownloaderViewModel            │
├─────────────────────────────────────────────────┤
│              Domain / Feature Layer              │
│  DownloadManager, InstallManager,                │
│  SettingsManager, NetworkMonitor                 │
├─────────────────────────────────────────────────┤
│                Data Layer                        │
│  AppApi (interface)                              │
│  ├── AppApiImpl (Retrofit + OkHttp)              │
│  └── LocalAppApiImpl (Preview/测试用)             │
│  Room Database (DownloadItem, PlayRecord)         │
│  DataStore Preferences (Settings)                │
├─────────────────────────────────────────────────┤
│           Dependency Injection (Hilt)            │
│  DataModule, DownloaderModule, InstallModule,    │
│  NetworkModule, DatabaseModule, SettingsModule   │
└─────────────────────────────────────────────────┘
```

### 3.2 技术栈

| 类别 | 技术选型 |
|------|---------|
| UI 框架 | Jetpack Compose + AndroidX TV Material |
| 导航 | Navigation Compose (Type-Safe Routes) |
| 网络请求 | Retrofit 3.0 + OkHttp 5.1 + Gson |
| 图片加载 | Coil 3 (支持 SVG、OkHttp 网络层) |
| 本地数据库 | Room (DownloadItem、PlayRecord) |
| 偏好存储 | DataStore Preferences |
| 依赖注入 | Hilt (Dagger) + KSP |
| 序列化 | Kotlinx Serialization + Gson |
| 异步处理 | Kotlin Coroutines + Flow |
| 函数式编程 | Arrow Core |
| 屏幕适配 | AndroidAutoSize |
| 事件上报 | EventReportSdk (自有 AAR) |
| 构建工具 | Gradle 8.10.1 + Kotlin 2.2.0 + AGP |

### 3.3 数据流

```
服务端 API (appstore.intelligen.ltd:8084)
    │
    ├── /contentconfigapi/getContentConfig  → 获取首页分类和内容配置
    ├── /contentconfigapi/getInfo           → 获取游戏详情
    ├── /appapi/search2                     → 搜索游戏
    └── /contentconfigapi/getDownloadUrl    → 获取下载链接
    │
    ▼
AppApiImpl (Retrofit) → Flow<T>
    │
    ▼
ViewModel (collect Flow, 转换为 StateFlow)
    │
    ▼
Compose UI (collectAsState 渲染)
```

### 3.4 下载引擎架构

下载模块是项目中最复杂的部分，采用自研多线程分片下载引擎：

```
DownloadManager
  ├── DownloadJob (每个下载任务)
  │     ├── PartDownloader (分片下载器)
  │     ├── Part (下载分片，支持断点续传)
  │     └── DownloadDestination (文件写入)
  ├── DownloadMonitor (下载状态监控)
  ├── IDownloadListDb (Room, 任务持久化)
  ├── IDownloadPartListDb (文件存储, 分片信息持久化)
  └── Throttler (全局限速器)
```

特性：
- 多线程分片下载，支持断点续传
- 全局最大 5 个并发任务
- 支持全局限速
- 支持重复文件策略（覆盖/编号/中止）
- 下载链接过期时自动重新获取
- 磁盘空间不足检测（预留 50MB）
- OkHttp 连接池无并发限制
- 支持稀疏文件分配

### 3.5 导航结构

```
NavHost (startDestination = HomeRoute)
  ├── HomeRoute          → 首页（分类浏览 + 我的）
  ├── GameDetailsRoute   → 游戏详情（下载/安装/游玩）
  ├── SearchRoute        → 搜索
  ├── DownloaderRoute    → 下载管理
  ├── UninstallerRoute   → 卸载管理
  ├── InputRoute         → 手柄管理
  ├── SettingsRoute      → 设置
  ├── AboutRoute         → 关于
  └── WebRoute           → 内置浏览器
```

### 3.6 Hilt DI 模块

| 模块 | 提供的依赖 |
|------|-----------|
| DataModule | AppApi (AppApiImpl) |
| DownloaderModule | DownloadManager, DownloadMonitor, DownloaderClient, DownloadSettings, 分片存储等 |
| InstallModule | InstallManager |
| NetworkModule | NetworkMonitor (ConnectivityManagerNetworkMonitor) |
| DatabaseModule | AppDatabase, IDownloadListDb, PlayRecordDao |
| SettingsModule | SettingsManager |
| DispatchersModule | IO Dispatcher |

---

## 4. 项目特点与设计决策

1. **系统级应用**：使用 `android.uid.system` 共享 UID 和平台签名，可以静默安装/卸载应用，无需用户确认
2. **TV 优化**：使用 `androidx.tv:tv-material`，支持 D-Pad 焦点导航，横屏固定，Leanback Launcher 入口
3. **双游戏类型**：同时支持 APK 原生游戏（下载安装）和 H5 网页游戏（WebView 直接打开）
4. **自研下载引擎**：完整的多线程分片下载实现，而非使用系统 DownloadManager
5. **响应式架构**：全面使用 Kotlin Flow + StateFlow，从数据层到 UI 层的响应式数据流
6. **Deep Link 支持**：支持 `gamecenter://details` 和 http/https 链接跳转
7. **事件上报**：集成自有 EventReportSdk 进行用户行为追踪
